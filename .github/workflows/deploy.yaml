name: build-and-deploy
on:
  push:
    branches: ["main"]
    paths:
      - "web-revised/**"
      - "was/**"
      - "apps/web-frontend/**"
      - "apps/was-api/**"

permissions:
  contents: write
  packages: write

concurrency:
  group: build-deploy
  cancel-in-progress: true

env:
  ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
  ARGOCD_AUTH_TOKEN: ${{ secrets.ARGOCD_AUTH_TOKEN }}

jobs:
  web-frontend:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    env:
      CONTEXT_DIR: web-revised
      MANIFEST_DIR: apps/web-frontend
      IMAGE: ghcr.io/unklo1200/web-updated
      TAG: v${{ github.run_number }}

    steps:
      - uses: actions/checkout@v4

      - name: Detect changes safely (web)
        id: web_changed
        shell: bash
        run: |
          set -euo pipefail
          if git rev-parse --verify HEAD^ >/dev/null 2>&1; then
            if git diff --quiet HEAD^ HEAD -- "$CONTEXT_DIR" "$MANIFEST_DIR"; then
              echo "changed=false" >> $GITHUB_OUTPUT
            else
              echo "changed=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "First run: treating as changed."
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Login to GHCR
        if: steps.web_changed.outputs.changed == 'true'
        run: echo "${{ secrets.GHCR_PAT || github.token }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build & Push (web)
        if: steps.web_changed.outputs.changed == 'true'
        run: |
          set -euo pipefail
          docker build -t $IMAGE:$TAG "$CONTEXT_DIR"
          docker push $IMAGE:$TAG

      - name: Install yq
        if: steps.web_changed.outputs.changed == 'true'
        run: |
          sudo curl -L https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -o /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq

      - name: Update manifests image (web-frontend)
        if: steps.web_changed.outputs.changed == 'true'
        run: |
          set -euo pipefail
          find "$MANIFEST_DIR" -type f \( -iname "*deploy*.y*ml" -o -iname "*deployment*.y*ml" \) -print0 \
          | xargs -0 -I{} sh -c 'yq -i '"'"'(.spec.template.spec.containers[].image) = env(IMAGE) + ":" + env(TAG)'"'"' "{}"'
          if ! git diff --quiet; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit -am "web-frontend: set image to $IMAGE:$TAG [skip ci]"
            git push
          else
            echo "No manifest changes to commit."
          fi

      - name: Argo CD sync (auto-detect transport)
        if: steps.web_changed.outputs.changed == 'true'
        env:
          APP_NAME: web-frontend
        run: |
          set -euo pipefail
          if [ -z "${ARGOCD_SERVER:-}" ] || [ -z "${ARGOCD_AUTH_TOKEN:-}" ]; then
            echo "Skipping Argo CD sync: missing secrets"; exit 0
          fi
          echo "::add-mask::${ARGOCD_AUTH_TOKEN}"

          if ! command -v argocd >/dev/null 2>&1; then
            curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
            chmod +x /usr/local/bin/argocd
          fi
          argocd version --client

          timeout 3 bash -c "cat < /dev/null > /dev/tcp/${ARGOCD_SERVER}/443" \
            && echo "443 reachable" || (echo "443 not reachable to $ARGOCD_SERVER"; exit 1)

          ROOT_PATH=""
          CODE_ROOT=$(curl -skI "https://${ARGOCD_SERVER}/"        | head -n1 | awk '{print $2}' || true)
          CODE_SUB=$(curl -skI "https://${ARGOCD_SERVER}/argocd/"  | head -n1 | awk '{print $2}' || true)
          if [ "${CODE_SUB:-}" = "200" ] || [ "${CODE_SUB:-}" = "302" ]; then
            ROOT_PATH="/argocd"
            echo "Detected subpath install at /argocd (HTTP ${CODE_SUB})"
          else
            echo "Detected root-path install (HTTP ${CODE_ROOT:-?})"
          fi

          do_login_and_sync () {
            local MODE="$1"
            echo "[MODE] $MODE"
            case "$MODE" in
              grpcweb-root)
                argocd login "$ARGOCD_SERVER" --auth-token "$ARGOCD_AUTH_TOKEN" --insecure \
                  --grpc-web --grpc-web-root-path "${ROOT_PATH:-/argocd}"
                ;;
              grpcweb)
                argocd login "$ARGOCD_SERVER" --auth-token "$ARGOCD_AUTH_TOKEN" --insecure \
                  --grpc-web
                ;;
              direct)
                argocd login "$ARGOCD_SERVER" --auth-token "$ARGOCD_AUTH_TOKEN" --insecure
                ;;
              *) echo "unknown mode: $MODE"; return 2;;
            esac
            argocd account get-user-info
            if [ "$MODE" = "direct" ]; then
              argocd app sync "$APP_NAME" --prune
            else
              argocd app sync "$APP_NAME" --grpc-web --prune
            fi
            argocd app wait "$APP_NAME" --health --timeout 300
          }

          set +e
          if [ -n "$ROOT_PATH" ]; then
            do_login_and_sync grpcweb-root; RC=$?
            if [ $RC -ne 0 ]; then
              echo "grpcweb-root failed, trying grpcweb..."
              do_login_and_sync grpcweb; RC=$?
            fi
          else
            do_login_and_sync direct; RC=$?
            if [ $RC -ne 0 ]; then
              echo "direct failed, trying grpcweb..."
              do_login_and_sync grpcweb; RC=$?
            fi
          fi
          set -e

          if [ ${RC:-1} -ne 0 ]; then
            echo "All Argo CD login modes failed (EOF/TLS/proxy mismatch suspected)."
            exit $RC
          fi

  was-api:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    env:
      CONTEXT_DIR: was
      MANIFEST_DIR: apps/was-api
      IMAGE: ghcr.io/unklo1200/was-updated
      TAG: v${{ github.run_number }}

    steps:
      - uses: actions/checkout@v4

      - name: Detect changes safely (was)
        id: was_changed
        shell: bash
        run: |
          set -euo pipefail
          if git rev-parse --verify HEAD^ >/dev/null 2>&1; then
            if git diff --quiet HEAD^ HEAD -- "$CONTEXT_DIR" "$MANIFEST_DIR"; then
              echo "changed=false" >> $GITHUB_OUTPUT
            else
              echo "changed=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "First run: treating as changed."
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Login to GHCR
        if: steps.was_changed.outputs.changed == 'true'
        run: echo "${{ secrets.GHCR_PAT || github.token }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build & Push (was)
        if: steps.was_changed.outputs.changed == 'true'
        run: |
          set -euo pipefail
          docker build -t $IMAGE:$TAG "$CONTEXT_DIR"
          docker push $IMAGE:$TAG

      - name: Install yq
        if: steps.was_changed.outputs.changed == 'true'
        run: |
          sudo curl -L https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -o /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq

      - name: Update manifests image (was-api)
        if: steps.was_changed.outputs.changed == 'true'
        run: |
          set -euo pipefail
          find "$MANIFEST_DIR" -type f \( -iname "*deploy*.y*ml" -o -iname "*deployment*.y*ml" \) -print0 \
          | xargs -0 -I{} sh -c 'yq -i '"'"'(.spec.template.spec.containers[].image) = env(IMAGE) + ":" + env(TAG)'"'"' "{}"'
          if ! git diff --quiet; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit -am "was-api: set image to $IMAGE:$TAG [skip ci]"
            git push
          else
            echo "No manifest changes to commit."
          fi

      - name: Argo CD sync (auto-detect transport)
        if: steps.was_changed.outputs.changed == 'true'
        env:
          APP_NAME: was-api
        run: |
          set -euo pipefail
          if [ -z "${ARGOCD_SERVER:-}" ] || [ -z "${ARGOCD_AUTH_TOKEN:-}" ]; then
            echo "Skipping Argo CD sync: missing secrets"; exit 0
          fi
          echo "::add-mask::${ARGOCD_AUTH_TOKEN}"

          if ! command -v argocd >/dev/null 2>&1; then
            curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
            chmod +x /usr/local/bin/argocd
          fi
          argocd version --client

          timeout 3 bash -c "cat < /dev/null > /dev/tcp/${ARGOCD_SERVER}/443" \
            && echo "443 reachable" || (echo "443 not reachable to $ARGOCD_SERVER"; exit 1)

          ROOT_PATH=""
          CODE_ROOT=$(curl -skI "https://${ARGOCD_SERVER}/"        | head -n1 | awk '{print $2}' || true)
          CODE_SUB=$(curl -skI "https://${ARGOCD_SERVER}/argocd/"  | head -n1 | awk '{print $2}' || true)
          if [ "${CODE_SUB:-}" = "200" ] || [ "${CODE_SUB:-}" = "302" ]; then
            ROOT_PATH="/argocd"
            echo "Detected subpath install at /argocd (HTTP ${CODE_SUB})"
          else
            echo "Detected root-path install (HTTP ${CODE_ROOT:-?})"
          fi

          do_login_and_sync () {
            local MODE="$1"
            echo "[MODE] $MODE"
            case "$MODE" in
              grpcweb-root)
                argocd login "$ARGOCD_SERVER" --auth-token "$ARGOCD_AUTH_TOKEN" --insecure \
                  --grpc-web --grpc-web-root-path "${ROOT_PATH:-/argocd}"
                ;;
              grpcweb)
                argocd login "$ARGOCD_SERVER" --auth-token "$ARGOCD_AUTH_TOKEN" --insecure \
                  --grpc-web
                ;;
              direct)
                argocd login "$ARGOCD_SERVER" --auth-token "$ARGOCD_AUTH_TOKEN" --insecure
                ;;
              *) echo "unknown mode: $MODE"; return 2;;
            esac
            argocd account get-user-info
            if [ "$MODE" = "direct" ]; then
              argocd app sync "$APP_NAME" --prune
            else
              argocd app sync "$APP_NAME" --grpc-web --prune
            fi
            argocd app wait "$APP_NAME" --health --timeout 300
          }

          set +e
          if [ -n "$ROOT_PATH" ]; then
            do_login_and_sync grpcweb-root; RC=$?
            if [ $RC -ne 0 ]; then
              echo "grpcweb-root failed, trying grpcweb..."
              do_login_and_sync grpcweb; RC=$?
            fi
          else
            do_login_and_sync direct; RC=$?
            if [ $RC -ne 0 ]; then
              echo "direct failed, trying grpcweb..."
              do_login_and_sync grpcweb; RC=$?
            fi
          fi
          set -e

          if [ ${RC:-1} -ne 0 ]; then
            echo "All Argo CD login modes failed (EOF/TLS/proxy mismatch suspected)."
            exit $RC
